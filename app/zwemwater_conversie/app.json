[{"name":"app.R","content":"#\r\n# This is a Shiny web application. You can run the application by clicking\r\n# the 'Run App' button above.\r\n#\r\n# Find out more about building applications with Shiny here:\r\n#\r\n#    http://shiny.rstudio.com/\r\n#\r\n\r\nlibrary(shiny)\r\nlibrary(readr)\r\nlibrary(dplyr)\r\nlibrary(readxl)\r\nlibrary(glue)\r\n# library(DT)\r\n\r\nselectie <- c(#\"Monster.identificatie\" = \"Id text\",\r\n              # \"Meetobject.Namespace\" = \"\",\r\n              \"Meetobject.lokaalid\" = \"Sample name\",\r\n              \"Typering.code\" = \"Typering code\",\r\n              # \"Typering.omschrijving\" = \"Typering omschrijving\",\r\n              \"Grootheid.code\" = \"Grootheid code\",\r\n              # \"Grootheid.omschrijving\" = \"Grootheid omschrijving\",\r\n              \"Parameter.code\" = \"Parameter code\",\r\n              \"Parameter.groep\" = \"Parameter groep\",\r\n              # \"Parameter.omschrijving\" = \"Parameter omschrijving\",\r\n              \"Eenheid.code\" = \"Units\",\r\n              \"Hoedanigheid.code\" = \"Hoedanigheid code\",\r\n              \"AnalyseCompartiment.code\" = \"Compartiment code\",\r\n              \"Waardebewerkingsmethode.code\" = \"Waardepalingsmethode code\",\r\n              \"Waardebepalingsmethode.code\" = \"Waardebewerkingsmethode code\",\r\n              \"Begindatum\" = \"Zwem begindatum\",\r\n              \"Begintijd\" = \"Zwem begintijd\",\r\n              \"Einddatum\" = \"Zwem einddatum\",\r\n              \"Eindtijd\" = \"Zwem eindtijd\",\r\n              \"Limietsymbool\" = \"Limietsymbool\",\r\n              \"Numeriekewaarde\" = \"Numeriekewaarde\",\r\n              \"Alfanumeriekewaarde\" = \"Alfanumeriekewaarde\",\r\n              \"Kwaliteitsoordeel.code\" = \"Kwaliteits oordeel\")\r\n\r\n# Define UI for application that draws a histogram\r\nui <- fluidPage(\r\n\r\n    # Application title\r\n    titlePanel(\"Conversie zwemwaterbestanden\"),\r\n\r\n    # Sidebar with a slider input for number of bins \r\n    sidebarLayout(\r\n        sidebarPanel(\r\n\r\n            # h3(\"Uitvouwen\"),\r\n            fileInput(\"bestand\", label = h3(\"Selecteer een bestand voor conversie\")),\r\n            downloadButton(\"downloadData\", \"Geconverteerd bestand\"),\r\n            \r\n            # h3(\"Samenvouwen\"),\r\n            # fileInput(\"file_samenvouwen\", label = h3(\"OMS Excelbestand om samen te vouwen\")),\r\n            # downloadButton(\"downloadData_samengevouwen\", \"Download\"),\r\n            # \r\n            \r\n            hr(),\r\n            \r\n            p(\"Deze applicatie kan worden gebruikt om bestanden uit het LIMS van Aquon geschikt te maken voor het zwemwaterregister.\"),\r\n            p(\"Voor een correcte werking moeten alle benodigde kolommen aanwezig zijn. In de inkijkfunctie is dat mogelijk met 'Show all columns'\"),\r\n            \r\n            \r\n            width = 4\r\n            \r\n            \r\n            \r\n        ),\r\n\r\n        # Show a plot of the generated distribution\r\n        mainPanel(\r\n          \r\n          h1(textOutput(\"error\")),\r\n          \r\n          h3(\"Missende data\"),\r\n          \r\n           tableOutput(\"missend\"),\r\n          \r\n          h3(\"Overschrijdingen\"),\r\n           tableOutput(\"overschrijdend\")\r\n        )\r\n    )\r\n)\r\n\r\n# Define server logic required to draw a histogram\r\nserver <- function(input, output) {\r\n    \r\n    \r\n    zwemdata <- reactive({\r\n        req(input$bestand)\r\n\r\n           pad <- input$bestand[[1, 4]]\r\n           # print(filename)\r\n           readxl::read_excel(pad)\r\n           \r\n        })\r\n    \r\n    output$error <- renderText({\r\n      if (all(unname(selectie) %in% names(zwemdata()) )) {\r\n        \"\"\r\n      } else {\r\n        \"Er ontbreken kolommen in het databestand!\"\r\n      }\r\n      \r\n    })\r\n\r\n    output$missend <- renderTable({\r\n        req(input$bestand)\r\n        zwemdata() %>% \r\n          missende_data() \r\n      })\r\n    \r\n    output$overschrijdend <- renderTable({\r\n      req(input$bestand)\r\n      zwemdata() %>% \r\n        overschrijdingen()\r\n    })\r\n\r\n\r\n    output$downloadData <- downloadHandler(\r\n        filename = function() {\r\n            glue(\"{format(now(), '%Y-%m-%d %H%M')} import_zwemwaterportaal.csv\")\r\n        },\r\n        content = function(file) {\r\n            # openxlsx::write.xlsx(uitgevouwen(), file)\r\n          write_delim(zwemdata() %>% conversiefunctie(),\r\n                      file = file, delim = \";\", na = \"\") \r\n        }\r\n    )\r\n\r\n   \r\n   \r\n}\r\n\r\n# Run the application \r\nshinyApp(ui = ui, server = server)\r\n","type":"text"},{"name":"R/functies.R","content":"# read_data <- function(file){\r\n#   \r\n#   read_excel(file)\r\n#   \r\n# }\r\n\r\n\r\nselectie <- c(#\"Monster.identificatie\" = \"Id text\",\r\n  # \"Meetobject.Namespace\" = \"\",\r\n  \"Meetobject.lokaalid\" = \"Sample name\",\r\n  \"Typering.code\" = \"Typering code\",\r\n  # \"Typering.omschrijving\" = \"Typering omschrijving\",\r\n  \"Grootheid.code\" = \"Grootheid code\",\r\n  # \"Grootheid.omschrijving\" = \"Grootheid omschrijving\",\r\n  \"Parameter.code\" = \"Parameter code\",\r\n  \"Parameter.groep\" = \"Parameter groep\",\r\n  # \"Parameter.omschrijving\" = \"Parameter omschrijving\",\r\n  \"Eenheid.code\" = \"Units\",\r\n  \"Hoedanigheid.code\" = \"Hoedanigheid code\",\r\n  \"AnalyseCompartiment.code\" = \"Compartiment code\",\r\n  \"Waardebewerkingsmethode.code\" = \"Waardepalingsmethode code\",\r\n  \"Waardebepalingsmethode.code\" = \"Waardebewerkingsmethode code\",\r\n  \"Begindatum\" = \"Zwem begindatum\",\r\n  \"Begintijd\" = \"Zwem begintijd\",\r\n  \"Einddatum\" = \"Zwem einddatum\",\r\n  \"Eindtijd\" = \"Zwem eindtijd\",\r\n  \"Limietsymbool\" = \"Limietsymbool\",\r\n  \"Numeriekewaarde\" = \"Numeriekewaarde\",\r\n  \"Alfanumeriekewaarde\" = \"Alfanumeriekewaarde\",\r\n  \"Kwaliteitsoordeel.code\" = \"Kwaliteits oordeel\")\r\n\r\n# data <- read_data(\"testdata/data met alle kolommen.xls\")\r\n\r\n\r\nconversiefunctie <- function(data){\r\n  \r\n  data %>% \r\n    select(all_of(selectie)) %>% \r\n    mutate(Meetobject.Namespace = \"NLBW39\", .before = Meetobject.lokaalid) %>% \r\n    filter(Parameter.code %in% c(\"CHLFa\", \"E_COLI\", \"INTTNLETRCCN\") | \r\n             Typering.code %in% c(\"CATCANBTRDLG\", \"CATCANBTRMT\"),\r\n           Hoedanigheid.code != \"DNAKPN\") %>% \r\n    filter(!is.na(Numeriekewaarde))\r\n  \r\n}\r\n\r\n# schrijffunctie <- function(tabel){\r\n#   tabel %>% \r\n#     write_delim(file = glue(\"{format(now(), '%Y-%m-%d %H%M')} import_zwemwaterportaal.csv\"),\r\n#                 delim = \";\", na = \"\")\r\n# }\r\n\r\nmissende_data <- function(data){\r\n  \r\n  data %>% \r\n    select(all_of(selectie)) %>% \r\n    mutate(Meetobject.Namespace = \"NLBW39\", .before = Meetobject.lokaalid) %>% \r\n    filter(Parameter.code %in% c(\"CHLFa\", \"E_COLI\", \"INTTNLETRCCN\") | \r\n             Typering.code %in% c(\"CATCANBTRDLG\", \"CATCANBTRMT\"),\r\n           Hoedanigheid.code != \"DNAKPN\") %>% \r\n    filter(is.na(Numeriekewaarde)) %>% \r\n    select(Meetobject.lokaalid, Typering.code, Parameter.code, Begindatum, Begintijd)\r\n  \r\n}\r\n\r\noverschrijdingen <- function(data) {\r\n  data %>% \r\n    conversiefunctie() %>% \r\n    filter(Parameter.code == \"E_COLI\" & Numeriekewaarde > 1800 |\r\n           Parameter.code == \"INTTNLETRCCN\" & Numeriekewaarde > 400 |\r\n           Hoedanigheid.code == \"toxblauw\" & Numeriekewaarde > 12 |\r\n            Typering.code == \"CATCANBTRDLG\" & Numeriekewaarde == 3\r\n           ) %>% \r\n    select(Meetobject.lokaalid, Typering.code, Parameter.code, Hoedanigheid.code, Begindatum, Begintijd, Numeriekewaarde, Eenheid.code)\r\n    \r\n}\r\n#   \r\n# data %>% \r\n#   overschrijdingen()\r\n  \r\n# \r\n# file <- \"testdata/data met alle kolommen.xls\"\r\n# \r\n# file %>% \r\n#   read_excel() %>% \r\n#   conversiefunctie() %>% \r\n#   schrijffunctie()\r\n#   \r\n# \r\n# schrijffunctie\r\n\r\n\r\n\r\n# data %>% select(all_of(selectie))\r\n","type":"text"}]
